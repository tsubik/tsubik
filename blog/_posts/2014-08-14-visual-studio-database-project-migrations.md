--- 
layout: post
title: "Visual Studio database project migrations"
tags: [".NET","Visual Studio","Database", "Migrations"]
date: 2014-08-14
author: "Tomasz Subik"
permalink: /blog/visual-studio-database-project-migrations/
---

Visual Studio Database project is a good way to quickly get your database under source control. You will find it very useful especially if your system has a large database schema with a huge pile of stored procedures, functions, views or other database centric stuff. Unfortunately, the deployment strategy brought with it is painful and detached from reality. Automated migration of production database to the latest version is hmmm.... I won't say impossible. I read about it, but it was like fixing sinking submarine using bare hands. Some people use [roundhouse](https://github.com/chucknorris/roundhouse) which is a very nice project to manage database migrations using differential scripts. Below you will find pros/cons of using both of these tools. 

<!--more-->

Database project
--------

Pros:

*	integration with visual studio. You can use a database designer instead of writing "alter/create scripts"
*	performing comparisons with other databases/database projects using schema comparison tool
*	keeping the whole schema in the project 
*	creating fresh database from schema instead of performing migrations
*	live validation of database schema - very easy refactoring with visual studio

Cons:

*	automated database migrations sucks
*	no database version control solution provided out of the box
*	if you have a large database it takes a lot of memory to hold database schema 

Roundhouse
--------

Pros:

*	automate database migrations using differential scripts and updating only procedures/views/functions which have changed
*	database version control solution

Cons:

*	creating "clear" database by running all migrations
*	You do not know what database schema looks like unless you create the database

Why not both?
--------

Why not to use these tools together? Cooperation will bring you something like this:

Pros:

*	integration with visual studio. You can use a database designer instead of writing "alter/create scripts" (DB Proj)
*	performing comparisons with other databases/database projects using schema comparison tool (DB Proj)
*	keeping the whole schema in the project  (DB Proj)
*	creating fresh database from schema instead of performing migrations (DB Proj)
*	live validation of database schema - very easy refactoring with visual studio (DB Proj)
*	automate database migrations using differential scripts and updating only procedures/views/functions which have changed (Roundhouse)
*	database version control (Roundhouse)

Cons:

*	if you have a large database it takes a lot of memory to hold database schema

Looks better, but of course it needs some additional work to be done because roundhouse does not play well with stored procedures scripts from database project.
I had to customize rh library to support following:

*	schema bound views - I need this because we have that kind of views in the database. 
*	database project create/alter script convention for stored procedures/functions - create if not exists then alter instead of only creating object
*	a way to record roundhouse migration in database without actually run it. Baseline mode.

All these things are implemented on my [branch develop](https://github.com/tsubik/roundhouse/tree/develop).

Development process
-------

To show how the development process will look like I've created a sample solution called Sampletico. Just pretend that Sampletico will be another task management system, for the time it has only user management feature implemented and we will add tasks storage option.
First we will add <code class="inline">Task</code> class

{% highlight c# %}
public class Task : Entity
{
	public int Id { get; set; }
	public string Note { get; set; }
	public int Priority { get; set; }
	public User CreatedByUser { get; set; }
	public User AssignedToUser { get; set; }
}
{% endhighlight %}
Then using database designer within visual studio we will add Tasks table
[Tasks table screen]

We also will need schema comparison profile file which compares our db project with local database. By default we ignore stored procedures/functions/views because roundhouse takes care of them.
To create migration we will use visual studio schema compare tools either manually or using described by previous post adding migration powershell script.
Here we have result migration file generated by script and cleaned from unnecessary data.

<script src="https://github.com/tsubik/Sampletico/blob/master/SampleticoDB/Scripts/Migrations/up/20140813025257_Tasks_Table.sql"></script>


![Migration file added to solution](/images/blog/migration_file.jpg)

To perform migration we will use roundhouse library. The simplest way is to use rh console application, but I've created extra console application to generate sample and static data and perform migrations.

<script src="https://github.com/tsubik/Sampletico/blob/master/run_migrations.bat"></script>

What about stored procedures?
------

What about them? It is simple, just add or update procedure, function or view in your database project. Roundhouse will take care of the rest.
Let's add new procedure to get all tasks

Now we can run migrations

And that's it. To use this method you must to remeber key concepts:
1.	All changes in database schema must be perfom in visual studio solution, never directly on the database.
2.	Changes in all databases must be perform by running migrations.
3.	New database could be created by publishing database project and then running rh tools in baseline mode to store information in database that all migrations have already run. 

Have fun.




I managed to find only one which satisfied these needs - [roundhouse](https://github.com/chucknorris/roundhouse). Unfortunately, there were some problems in applying roundhouse to this project but maybe a detailed migration process is a topic for another post. There were, in short, some changes to be made in rh library and I didn't like its way of creating database which was "get initial schema and run all migrations". I preferred to create a "fresh" database directly from schema which would support database project and that's why I am using both roundhouse (to apply migrations and changes in views/stored procs/functions - and in general keeping database in specific version) and database project (to keep schema in source control and creating database from schema). 



<script src="https://gist.github.com/tsubik/34d2d80e90a924fc718c.js"></script>

To create migration you must have solution with database project opened.
Running script will add migration file to your solution (do not mess around in editor while script is running).



Examples:

<code>
PM> .\AddMigration.ps1 –n MigrationName 
</code>

For other database project in solution
 
<code>
PM> .\AddMigration.ps1 –n MigrationName –p NotDefaultDatabaseProject 
</code>

To generate only empty file for migration

<code>
PM> .\AddMigrations.ps1 –n MigrationName –of
</code>

This solution is not ideal mainly because is too slow, but it is working and is better than manually doing this.
